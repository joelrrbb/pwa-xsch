<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/joelrrbb/cdn-assets@main/css/layui.css">
  <style>
    body { padding: 20px; background-color: #fff; }
    .layui-form-label { width: 100px; }
    .layui-input-block { margin-left: 130px; }
  </style>
</head>
<body>

<form class="layui-form" id="addUserForm">

  <!-- Nombre -->
  <div class="layui-form-item">
    <label class="layui-form-label">Nombre</label>
    <div class="layui-input-block">
      <input type="text"
             name="name"
             placeholder="Nombre completo"
             class="layui-input">
    </div>
  </div>

  <!-- Teléfono -->
  <div class="layui-form-item">
    <label class="layui-form-label">Teléfono</label>
    <div class="layui-input-block">
      <input type="tel"
             name="phone"
             maxlength="8"
             oninput="this.value=this.value.replace(/[^0-9]/g,'')"
             required
             lay-verify="required|number"
             placeholder="Ej. 76543210"
             class="layui-input">
    </div>
  </div>

  <!-- Tipo -->
  <div class="layui-form-item">
    <label class="layui-form-label">Tipo</label>
    <div class="layui-input-block">
      <select name="member_type" class="layui-input">
        <option value="1" selected>Voluntario</option>
        <option value="2">Militante</option>
        <option value="3">Consejal</option>
        <option value="4">Asambleísta</option>
      </select>
    </div>
  </div>

  <!-- Tier (sin JS) -->
  <div class="layui-form-item">
  <label class="layui-form-label">Nivel</label>
  <div class="layui-input-block">
    <select name="tier" class="layui-input">
      <option value="1" selected>1</option>
      <option value="0">--</option>
    </select>
  </div>
</div>
  
  <div class="layui-form-item">
  <label class="layui-form-label">Supervisor</label>
  <div class="layui-input-block">
    <div id="manager-select" style="width: 100%;"></div>
  </div>
</div>

  <!-- Hidden fijos -->
  <input type="hidden" name="points" value="0">
  <input type="hidden" name="is_verified" value="0">

  <!-- Botón -->
  <div class="layui-form-item" style="margin-top:25px;">
    <div class="layui-input-block">
      <button class="layui-btn layui-btn-normal layui-btn-fluid"
              lay-submit
              lay-filter="saveUser">
        Guardar Usuario
      </button>
    </div>
  </div>

</form>

<script src="https://cdn.jsdelivr.net/gh/joelrrbb/cdn-assets@main/js/layui.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/joelrrbb/cdn-assets@main/xm-select/xm-select.js"></script>

<script>
layui.use(['form', 'layer'], function () {
  var form = layui.form;
  var layer = layui.layer;
  
  var managerSelect = xmSelect.render({
    el: '#manager-select', 
    name: 'manager_phone', // Nombre del campo que llegará al backend
    filterable: true,      // Permitir buscar
    radio: true,           // Selección única (un usuario tiene un manager)
    clickClose: true,      // Cerrar al seleccionar
	tips: 'Seleccione un supervisor',
	searchTips: 'Buscar por nombre...',
	empty: 'No se encontraron managers',
    model: { label: { type: 'text' } }, // Mostrar solo texto en el input
    data: [] 
  });

  // 2. Cargar datos desde tu API
  axios.get('/api/managers-active')
    .then(res => {
      if (res.data.code === 0) {
        // Transformar los datos para el formato de XM-SELECT
        const mappedData = res.data.data.map(item => ({
          name: item.name || 'Sin nombre', 
          value: item.phone, // Lo que se enviará (teléfono)
          selected: false
        }));
        
        // Actualizar el componente con los datos reales
        managerSelect.update({
          data: mappedData
        });
      }
    })
    .catch(err => console.error('Error cargando managers', err));

  form.on('submit(saveUser)', function (data) {
    var loading = layer.load(2);
	var selectValue = managerSelect.getValue('valueStr'); 
    data.field.manager_phone = selectValue;

    axios.post('/api/add-user', data.field)
      .then(() => {
        layer.close(loading);
        parent.layui.layer.msg('Usuario registrado con éxito', { icon: 1 });
        parent.layui.table.reload('mainTable');
        parent.layer.close(parent.layer.getFrameIndex(window.name));
      })
      .catch(err => {
        layer.close(loading);
        layer.msg(err.response?.data?.msg || 'Error al guardar', { icon: 2 });
      });

    return false;
  });
});
</script>

</body>
</html>
